{%- assign video_path = include.path -%}
{%- assign video_name = video_path | split: '/' | last | split: '.' | first -%}
{%- assign poster_path = 'assets/img/publication/' | append: video_name | append: '.png' -%}

<figure>
  <div class="video-container">
    <video 
      {% if include.class %}class="{{ include.class }}"{% endif %} 
      {% if include.controls %}controls{% endif %}
      {% if include.autoplay %}autoplay{% endif %}
      {% if include.loop %}loop{% endif %}
      {% if include.muted %}muted{% endif %}
      poster="{{ poster_path | relative_url }}"
      {% if include.width %}width="{{ include.width }}"{% endif %}
      {% if include.height %}height="{{ include.height }}"{% endif %}
      preload="metadata"
      playsinline
      webkit-playsinline
      onmouseover="this.controls=true"
      onmouseout="this.controls=false"
    >
      {%- assign video_ext = video_path | split: '.' | last | downcase -%}
      {%- if video_ext == 'mp4' -%}
        <source src="{{ video_path | relative_url }}" type="video/mp4">
      {%- elsif video_ext == 'webm' -%}
        <source src="{{ video_path | relative_url }}" type="video/webm">
      {%- elsif video_ext == 'ogg' -%}
        <source src="{{ video_path | relative_url }}" type="video/ogg">
      {%- else -%}
        <source src="{{ video_path | relative_url }}" type="video/mp4">
      {%- endif -%}
      <p>Your browser does not support the video tag. <a href="{{ video_path | relative_url }}">Download the video</a> instead.</p>
    </video>
  </div>
  {%- if include.caption -%}<figcaption class="caption">{{ include.caption }}</figcaption>{%- endif %}
</figure>

<style>
.video-container {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  background-color: #f8f9fa;
  border-radius: 8px;
  overflow: hidden;
}

.video-container video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 8px;
  background-color: #000;
}

.video-container video::-webkit-media-controls {
  background-color: rgba(0,0,0,0.5);
}

/* Chrome-specific fixes for gray mask */
.video-container video::-webkit-media-controls-panel {
  background-color: transparent;
}

.video-container video::-webkit-media-controls-play-button {
  background-color: transparent;
}

.video-container video::-webkit-media-controls-timeline {
  background-color: transparent;
}

/* Force Chrome to show video content properly */
.video-container video {
  background-color: #000 !important;
  background-image: none !important;
  object-fit: cover;
  /* Force Chrome to render video properly */
  -webkit-appearance: none;
  appearance: none;
}

/* Remove ALL Chrome default styling */
.video-container video::-webkit-media-controls {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-panel {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-overlay-play-button {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-start-playback-button {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-enclosure {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-fullscreen-button {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-timeline {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-volume-slider {
  background-color: transparent !important;
}

.video-container video::-webkit-media-controls-mute-button {
  background-color: transparent !important;
}

/* Force poster to be visible */
.video-container video[poster] {
  background-color: #000 !important;
  background-image: none !important;
}

/* Override any Chrome default video styling */
.video-container video::-webkit-media-controls-container {
  background-color: transparent !important;
}

</style>

<script>
// Aggressive Chrome gray mask fix
document.addEventListener('DOMContentLoaded', function() {
  const videos = document.querySelectorAll('.video-container video');
  
  videos.forEach(function(video) {
    // Force immediate styling
    video.style.backgroundColor = '#000';
    video.style.backgroundImage = 'none';
    
    // Remove any Chrome default styling
    video.style.webkitAppearance = 'none';
    video.style.appearance = 'none';
    
    // Force poster to be visible
    if (video.poster) {
      video.style.backgroundImage = 'url(' + video.poster + ')';
      video.style.backgroundSize = 'cover';
      video.style.backgroundPosition = 'center';
    }
    
    // Handle all video events to prevent gray mask
    const events = ['loadstart', 'loadedmetadata', 'loadeddata', 'canplay', 'canplaythrough', 'progress'];
    
    events.forEach(function(eventName) {
      video.addEventListener(eventName, function() {
        this.style.backgroundColor = '#000';
        this.style.backgroundImage = this.poster ? 'url(' + this.poster + ')' : 'none';
      });
    });
    
    // Force style on any interaction
    video.addEventListener('click', function() {
      this.style.backgroundColor = '#000';
    });
    
    video.addEventListener('mouseenter', function() {
      this.style.backgroundColor = '#000';
    });
    
    // Use MutationObserver to catch any style changes
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          video.style.backgroundColor = '#000';
          video.style.backgroundImage = video.poster ? 'url(' + video.poster + ')' : 'none';
        }
      });
    });
    
    observer.observe(video, { attributes: true, attributeFilter: ['style'] });
  });
});
</script>
